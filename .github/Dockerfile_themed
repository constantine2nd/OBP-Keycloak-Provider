# CI/CD Production Dockerfile — themed build
#
# Builds the provider JAR inside Docker (no pre-built artifacts needed on the host),
# then packages it with Keycloak and OBP custom themes.
#
# Usage (GitHub Actions):
#   docker build . --file .github/Dockerfile_themed --tag <image>
#
# All OBP API and Keycloak database configuration is supplied at container
# runtime via environment variables — nothing sensitive is baked into the image.
#
# Required runtime variables:
#   OBP_API_URL            — base URL of the OBP API instance
#   OBP_API_USERNAME       — OBP admin user (needs CanGetAnyUser, CanVerifyUserCredentials)
#   OBP_API_PASSWORD       — OBP admin password
#   OBP_API_CONSUMER_KEY   — consumer key registered in OBP for Direct Login
#   OBP_AUTHUSER_PROVIDER  — provider filter; only users with this provider are authenticated
#   KC_DB_URL              — Keycloak's internal PostgreSQL JDBC URL
#   KC_DB_USERNAME         — Keycloak database user
#   KC_DB_PASSWORD         — Keycloak database password

# === Stage 1: Build the provider JAR with Maven ===
FROM maven:3-eclipse-temurin-17 AS maven
WORKDIR /app
COPY . .
RUN mvn clean package -DskipTests -q

# Cache invalidation layer - forces rebuild when JAR changes
RUN echo "Build timestamp: ${BUILD_TIMESTAMP}" > /tmp/build-info.txt && \
    echo "JAR checksum: ${JAR_CHECKSUM}" >> /tmp/build-info.txt

# Build with Maven resource filtering using build arguments
RUN mvn clean install -DskipTests=true \
    -DDB_URL="${DB_URL}" \
    -DDB_USER="${DB_USER}" \
    -DDB_PASSWORD="${DB_PASSWORD}" \
    -DDB_DRIVER="${DB_DRIVER}" \
    -DDB_DIALECT="${DB_DIALECT}" \
    -DKC_DB_URL="${KC_DB_URL}" \
    -DKC_DB_USERNAME="${KC_DB_USERNAME}" \
    -DKC_DB_PASSWORD="${KC_DB_PASSWORD}" \
    -DHIBERNATE_DDL_AUTO="${HIBERNATE_DDL_AUTO}" \
    -DHIBERNATE_SHOW_SQL="${HIBERNATE_SHOW_SQL}" \
    -DHIBERNATE_FORMAT_SQL="${HIBERNATE_FORMAT_SQL}"

# Use official Keycloak image as a base for building
FROM quay.io/keycloak/keycloak:26.5.1 as builder

# Build arguments for cache invalidation
ARG BUILD_TIMESTAMP
ARG JAR_CHECKSUM
RUN mvn clean install -DskipTests=true

FROM quay.io/keycloak/keycloak:26.5.1 AS builder

ENV KC_HEALTH_ENABLED=true
ENV KC_METRICS_ENABLED=true
ENV KC_FEATURES=token-exchange
ENV KC_DB=postgres

WORKDIR /opt/keycloak
USER root

# Generate a self-signed SSL certificate for HTTPS
RUN keytool -genkeypair -storepass password -storetype PKCS12 \
    -keyalg RSA -keysize 2048 -dname "CN=server" -alias server \
    -ext "SAN:c=DNS:localhost,IP:127.0.0.1" \
    -keystore conf/server.keystore

# Copy the provider JAR built in the maven stage
COPY --chown=keycloak:keycloak --from=maven /app/target/obp-keycloak-provider.jar /opt/keycloak/providers/

# Prebuild Keycloak (compile extensions, optimise)
RUN /opt/keycloak/bin/kc.sh build


# === Final Runtime Image ===
# Use the same Keycloak base image for the final runtime image
FROM quay.io/keycloak/keycloak:26.5.1

COPY --from=builder /opt/keycloak/ /opt/keycloak/

USER root

# Copy OBP themes
COPY themes/obp/ /opt/keycloak/themes/obp/
COPY themes/obp-dark/ /opt/keycloak/themes/obp-dark/
RUN chown -R keycloak:keycloak /opt/keycloak/themes/

# Copy the custom entrypoint wrapper that injects runtime ENV into theme config
COPY development/docker/docker-entrypoint.sh /opt/keycloak/docker-entrypoint.sh
RUN chmod 755 /opt/keycloak/docker-entrypoint.sh && chown keycloak:keycloak /opt/keycloak/docker-entrypoint.sh

USER keycloak

# Keycloak internal database — override all at runtime
ENV KC_DB=postgres
ENV KC_DB_URL=jdbc:postgresql://keycloak-postgres:5432/keycloak
ENV KC_DB_USERNAME=keycloak
ENV KC_DB_PASSWORD=keycloak_changeme

# OBP API configuration — override all at runtime
ENV OBP_API_URL=http://localhost:8080
ENV OBP_API_USERNAME=
ENV OBP_API_PASSWORD=
ENV OBP_API_CONSUMER_KEY=
ENV OBP_AUTHUSER_PROVIDER=

# Keycloak runtime defaults
ENV KC_HOSTNAME_STRICT=false
ENV KC_HOSTNAME_STRICT_HTTPS=false
ENV KC_HTTP_ENABLED=true
ENV KC_HEALTH_ENABLED=true
ENV KC_METRICS_ENABLED=true
ENV KC_FEATURES=token-exchange

# Custom "Forgot Password?" link — leave empty to use Keycloak's built-in flow
ENV FORGOT_PASSWORD_URL=

ENTRYPOINT ["/opt/keycloak/docker-entrypoint.sh", "start-dev", "--verbose"]
