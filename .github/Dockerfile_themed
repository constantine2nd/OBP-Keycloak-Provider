# === Build Stage ===
# Use Maven to build the project
FROM maven:3-eclipse-temurin-17 as maven

# Build arguments for cache invalidation
ARG BUILD_TIMESTAMP
ARG JAR_CHECKSUM

# Define build arguments for User Storage database environment variables
ARG DB_URL=jdbc:postgresql://localhost:5432/obp_mapped
ARG DB_USER=oidc_user
ARG DB_PASSWORD=your_secure_password
ARG DB_DRIVER=org.postgresql.Driver
ARG DB_DIALECT=org.hibernate.dialect.PostgreSQLDialect

# Define build arguments for Keycloak database environment variables
ARG KC_DB_URL=jdbc:postgresql://localhost:5433/keycloak
ARG KC_DB_USERNAME=keycloak
ARG KC_DB_PASSWORD=keycloak_changeme
ARG HIBERNATE_DDL_AUTO=validate
ARG HIBERNATE_SHOW_SQL=true
ARG HIBERNATE_FORMAT_SQL=true

FROM maven:3-eclipse-temurin-17 AS maven
COPY . /app
WORKDIR /app

# Cache invalidation layer - forces rebuild when JAR changes
RUN echo "Build timestamp: ${BUILD_TIMESTAMP}" > /tmp/build-info.txt && \
    echo "JAR checksum: ${JAR_CHECKSUM}" >> /tmp/build-info.txt

# Build with Maven resource filtering using build arguments
RUN mvn clean install -DskipTests=true \
    -DDB_URL="${DB_URL}" \
    -DDB_USER="${DB_USER}" \
    -DDB_PASSWORD="${DB_PASSWORD}" \
    -DDB_DRIVER="${DB_DRIVER}" \
    -DDB_DIALECT="${DB_DIALECT}" \
    -DKC_DB_URL="${KC_DB_URL}" \
    -DKC_DB_USERNAME="${KC_DB_USERNAME}" \
    -DKC_DB_PASSWORD="${KC_DB_PASSWORD}" \
    -DHIBERNATE_DDL_AUTO="${HIBERNATE_DDL_AUTO}" \
    -DHIBERNATE_SHOW_SQL="${HIBERNATE_SHOW_SQL}" \
    -DHIBERNATE_FORMAT_SQL="${HIBERNATE_FORMAT_SQL}"

# Use official Keycloak image (26.0.5) as a base for building
FROM quay.io/keycloak/keycloak:26.0.5 as builder

# Build arguments for cache invalidation
ARG BUILD_TIMESTAMP
ARG JAR_CHECKSUM
RUN mvn clean install -DskipTests=true

FROM quay.io/keycloak/keycloak:latest AS builder

# Enable Keycloak health and metrics endpoints
ENV KC_HEALTH_ENABLED=true
ENV KC_METRICS_ENABLED=true
ENV KC_FEATURES=token-exchange
ENV KC_DB=postgres

# Set working directory inside the container
WORKDIR /opt/keycloak

# Switch to root user to perform privileged operations (e.g., keystore generation)
USER root

# Generate a self-signed SSL certificate for development/testing purposes
RUN keytool -genkeypair -storepass password -storetype PKCS12 \
    -keyalg RSA -keysize 2048 -dname "CN=server" -alias server \
    -ext "SAN:c=DNS:localhost,IP:127.0.0.1" \
    -keystore conf/server.keystore

# Add the PostgreSQL JDBC driver to the providers directory for database connectivity
ADD --chown=keycloak:keycloak https://jdbc.postgresql.org/download/postgresql-42.7.2.jar /opt/keycloak/providers/

# Copy build info and cache invalidation layer
COPY --from=maven /tmp/build-info.txt /tmp/build-info.txt

# Add your custom User Storage Provider (or other extensions) JAR
# This layer will be invalidated when the JAR changes due to the cache invalidation above
COPY --from=maven /app/target/obp-keycloak-provider.jar /opt/keycloak/providers/

# Prebuild the Keycloak server (e.g., compile extensions, optimize image)
RUN /opt/keycloak/bin/kc.sh build


# === Final Runtime Image ===
# Use the same Keycloak base image for the final runtime image
FROM quay.io/keycloak/keycloak:26.0.5

# Copy the entire prebuilt Keycloak directory (including config, keystore) from the builder stage
COPY --from=builder /opt/keycloak/ /opt/keycloak/

# Copy build info for debugging
COPY --from=builder /tmp/build-info.txt /opt/keycloak/

# Switch to root user to create theme directories and copy theme files
USER root

# Copy the entire theme directory structure
COPY themes/obp/ /opt/keycloak/themes/obp/

# Set proper ownership for theme files
RUN chown -R keycloak:keycloak /opt/keycloak/themes/obp

# Switch back to keycloak user for security
USER keycloak

# Set default environment variables for Keycloak's internal database
ENV KC_DB=postgres
ENV KC_DB_URL=jdbc:postgresql://keycloak-postgres:5432/keycloak
ENV KC_DB_USERNAME=keycloak
ENV KC_DB_PASSWORD=keycloak_changeme

# Set default environment variables for User Storage database configuration
ENV DB_URL=jdbc:postgresql://user-storage-postgres:5432/obp_mapped
ENV DB_USER=oidc_user
ENV DB_PASSWORD=your_secure_password
ENV DB_DRIVER=org.postgresql.Driver
ENV DB_DIALECT=org.hibernate.dialect.PostgreSQLDialect
ENV DB_AUTHUSER_TABLE=v_oidc_users

# Default Hibernate configuration for User Storage
ENV HIBERNATE_DDL_AUTO=validate
ENV HIBERNATE_SHOW_SQL=true
ENV HIBERNATE_FORMAT_SQL=true

# Default Keycloak runtime configuration
ENV KC_HOSTNAME_STRICT=false
ENV KC_HOSTNAME_STRICT_HTTPS=false
ENV KC_HTTP_ENABLED=true
ENV KC_HEALTH_ENABLED=true
ENV KC_METRICS_ENABLED=true
ENV KC_FEATURES=token-exchange
ENV HIBERNATE_DDL_AUTO=validate
ENV HIBERNATE_SHOW_SQL=true
ENV HIBERNATE_FORMAT_SQL=true

# Theme will be automatically available as 'obp' theme in Keycloak admin console
# No need to set as default - users can select it in Realm Settings > Themes

# Start Keycloak in development mode (enables features like auto-reload, less strict config)
ENTRYPOINT ["/opt/keycloak/bin/kc.sh", "start-dev", "--verbose"]
