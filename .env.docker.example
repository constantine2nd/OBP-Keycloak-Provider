# OBP Keycloak Provider - Docker Environment Configuration Example
# Copy this file to .env for docker-compose usage
#
# BREAKING CHANGE NOTICE:
# OBP_AUTHUSER_PROVIDER is now MANDATORY - system will fail to start if not set
# This variable ensures provider-based user filtering for security and multi-tenancy

# =============================================================================
# MANDATORY SECURITY CONFIGURATION
# =============================================================================
# CRITICAL: This variable is REQUIRED and system will fail to start if not set
# Choose a provider name that matches your database provider field values
# Examples: obp_production, obp_development, tenant_a, bank_xyz, etc.
OBP_AUTHUSER_PROVIDER=obp_production

# =============================================================================
# KEYCLOAK ADMIN CONFIGURATION
# =============================================================================
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=secure_admin_password_change_me

# =============================================================================
# KEYCLOAK'S INTERNAL DATABASE CONFIGURATION
# This database stores Keycloak's realm data, users, clients, tokens, etc.
# =============================================================================
KC_DB_NAME=keycloak
KC_DB_USERNAME=keycloak
KC_DB_PASSWORD=secure_keycloak_db_password_change_me
KC_DB_PORT=5433
KC_DB_URL=jdbc:postgresql://keycloak-postgres:5432/keycloak

# =============================================================================
# USER STORAGE DATABASE CONFIGURATION
# This database contains the external user data that Keycloak federates
# =============================================================================
USER_STORAGE_DB_NAME=obp_mapped
USER_STORAGE_DB_USER=obp
USER_STORAGE_DB_PASSWORD=secure_user_storage_password_change_me
USER_STORAGE_DB_PORT=5434

# User Storage Database Configuration (used by OBP provider)
DB_URL=jdbc:postgresql://user-storage-postgres:5432/obp_mapped
DB_USER=${USER_STORAGE_DB_USER}
DB_PASSWORD=${USER_STORAGE_DB_PASSWORD}
DB_DRIVER=org.postgresql.Driver
DB_DIALECT=org.hibernate.dialect.PostgreSQLDialect
DB_AUTHUSER_TABLE=v_oidc_users

# =============================================================================
# HIBERNATE CONFIGURATION (for User Storage)
# =============================================================================
HIBERNATE_DDL_AUTO=validate
HIBERNATE_SHOW_SQL=true
HIBERNATE_FORMAT_SQL=true

# =============================================================================
# KEYCLOAK RUNTIME CONFIGURATION
# =============================================================================
KC_HOSTNAME_STRICT=false
KC_HOSTNAME_STRICT_HTTPS=false
KC_HTTP_ENABLED=true
KC_HEALTH_ENABLED=true
KC_METRICS_ENABLED=true
KC_FEATURES=token-exchange

# =============================================================================
# NETWORK PORTS
# =============================================================================
KEYCLOAK_HTTP_PORT=8000
KEYCLOAK_HTTPS_PORT=8443

# DATABASE PORTS (External Access)
KC_DB_PORT=5433          # Keycloak's internal database
USER_STORAGE_DB_PORT=5434 # User storage database (avoids conflicts with system PostgreSQL)

# =============================================================================
# PGADMIN CONFIGURATION (Optional - for database management)
# =============================================================================
KEYCLOAK_PGADMIN_EMAIL=keycloak-admin@obp.com
KEYCLOAK_PGADMIN_PASSWORD=admin
KEYCLOAK_PGADMIN_PORT=5051

USER_STORAGE_PGADMIN_EMAIL=user-storage-admin@obp.com
USER_STORAGE_PGADMIN_PASSWORD=admin
USER_STORAGE_PGLADMIN_PORT=5050

# =============================================================================
# ENVIRONMENT-SPECIFIC EXAMPLES
# =============================================================================

# Development Environment Example:
# OBP_AUTHUSER_PROVIDER=obp_development
# KEYCLOAK_ADMIN_PASSWORD=dev_admin_123
# KC_DB_PASSWORD=dev_keycloak_password
# USER_STORAGE_DB_PASSWORD=dev_user_storage_password

# Production Environment Example:
# OBP_AUTHUSER_PROVIDER=obp_production
# KEYCLOAK_ADMIN_PASSWORD=very_secure_production_admin_password
# KC_DB_PASSWORD=very_secure_keycloak_production_password
# USER_STORAGE_DB_PASSWORD=very_secure_user_storage_production_password

# Multi-tenant Examples:
# OBP_AUTHUSER_PROVIDER=tenant_alpha
# OBP_AUTHUSER_PROVIDER=tenant_beta
# OBP_AUTHUSER_PROVIDER=bank_acme
# OBP_AUTHUSER_PROVIDER=bank_global

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================
# 1. Copy this file: cp .env.docker.example .env
# 2. Edit the .env file with your actual values
# 3. MANDATORY: Set OBP_AUTHUSER_PROVIDER to match your database provider values
# 4. Change all default passwords for security
# 5. Start services: docker-compose -f docker-compose.runtime.yml up
#
# Verification Commands:
# - Check provider value: echo $OBP_AUTHUSER_PROVIDER
# - Check database provider values:
#   docker exec user-storage-postgres psql -U obp -d obp_mapped -c "SELECT DISTINCT provider FROM v_oidc_users;"
# - View logs: docker logs obp-keycloak | grep "Auth User Provider"

# =============================================================================
# SECURITY WARNINGS
# =============================================================================
# ðŸ”’ SECURITY CHECKLIST:
# [ ] Changed KEYCLOAK_ADMIN_PASSWORD from default
# [ ] Changed KC_DB_PASSWORD from default
# [ ] Changed USER_STORAGE_DB_PASSWORD from default
# [ ] Set OBP_AUTHUSER_PROVIDER to match your provider
# [ ] Verified provider value exists in your database
# [ ] Used strong passwords (minimum 12 characters)
# [ ] Considered using environment-specific .env files

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
# If you see "FATAL: Mandatory environment variable 'OBP_AUTHUSER_PROVIDER' is not set":
# - Ensure OBP_AUTHUSER_PROVIDER is set in this file
# - Verify the value matches provider field in your database
# - Restart containers after changing environment variables
#
# If authentication fails after setting provider:
# - Check database for correct provider values
# - Verify no duplicate usernames exist for the same provider
# - Review logs for "Ambiguous login attempt" messages
#
# Port conflicts:
# - Keycloak: http://localhost:8000 (change KEYCLOAK_HTTP_PORT if needed)
# - Keycloak DB: localhost:5433 (change KC_DB_PORT if needed)
# - User Storage DB: localhost:5434 (change USER_STORAGE_DB_PORT if needed)
